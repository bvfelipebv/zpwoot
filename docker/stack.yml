version: '3.8'

networks:
  infraNet:
    external: true

volumes:
  zpwoot_data_postgres:
  zpwoot_data_nats:
  zpwoot_data_zpwoot:

services:
  zpwoot_api:
    image: felipyfgs17/zpwoot:latest
    networks:
      - infraNet
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "1"
          memory: 1024M
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.zpwoot_api.rule=Host(`api.xapza.com`)"
        - "traefik.http.routers.zpwoot_api.entrypoints=websecure"
        - "traefik.http.routers.zpwoot_api.tls.certresolver=letsencryptresolver"
        - "traefik.http.routers.zpwoot_api.priority=1"
        - "traefik.http.routers.zpwoot_api.service=zpwoot_api"
        - "traefik.http.services.zpwoot_api.loadbalancer.server.port=8080"
        - "traefik.http.services.zpwoot_api.loadbalancer.passhostheader=true"
        - "traefik.http.middlewares.zpwoot_sslheader.headers.customrequestheaders.X-Forwarded-Proto=https"
        - "traefik.http.routers.zpwoot_api.middlewares=zpwoot_sslheader@docker"
        - "traefik.docker.network=infraNet"
    environment:
      - PORT=8080
      - ENVIRONMENT=production
      - DATABASE_DRIVER=postgres
      - DATABASE_URL=postgres://zpwoot:zpwoot123@zpwoot_postgres:5432/zpwoot?sslmode=disable
      - NATS_URL=nats://zpwoot_nats:4222
      - API_KEY=your-secret-api-key-change-in-production
      - LOG_LEVEL=info
      - WHATSAPP_DATA_DIR=/app/data
      - MAX_SESSIONS=10
      - CONNECTION_TIMEOUT=30
      - PAIRING_TIMEOUT=120
      - AUTO_RESTORE_SESSIONS=true
      - WEBHOOK_WORKERS=10
      - WEBHOOK_TIMEOUT=30s
      - WEBHOOK_MAX_RETRIES=3
      - WEBHOOK_RETRY_BASE_DELAY=5s
      - NATS_MAX_RECONNECT=10
      - NATS_RECONNECT_WAIT=2s
    volumes:
      - zpwoot_data_zpwoot:/app/data

  zpwoot_postgres:
    image: postgres:16-alpine
    networks:
      - infraNet
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
    environment:
      - POSTGRES_USER=zpwoot
      - POSTGRES_PASSWORD=zpwoot123
      - POSTGRES_DB=zpwoot
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --locale=C
    volumes:
      - zpwoot_data_postgres:/var/lib/postgresql/data

  zpwoot_nats:
    image: nats:latest
    networks:
      - infraNet
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
    command:
      - "--http_port=8222"
      - "--js"
      - "--store_dir=/data"
    volumes:
      - zpwoot_data_nats:/data